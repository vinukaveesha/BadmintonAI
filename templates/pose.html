{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2>Live Shot Recognition with Pose Estimation</h2>
    <div class="row">
        <div class="col-md-8">
            <div class="video-container">
                <video id="inputVideo" class="video" autoplay playsinline></video>
                <canvas id="outputCanvas" class="video"></canvas>
            </div>
            <button id="recordBtn" class="btn btn-primary mt-3" onclick="startRecording()">
                Start Recording (5 seconds)
            </button>
            <div id="result" class="mt-3">
                <h4>Prediction: <span id="predictionResult">-</span></h4>
                <h4>Confidence: <span id="confidenceResult">-</span>%</h4>
            </div>
        </div>
    </div>
</div>

<!-- Include MediaPipe dependencies -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>

<script>
const videoElement = document.getElementById('inputVideo');
const canvasElement = document.getElementById('outputCanvas');
const canvasCtx = canvasElement.getContext('2d');
let mediaRecorder;
let recordedChunks = [];

// Initialize MediaPipe Pose
const pose = new Pose({
    locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
    }
});

pose.setOptions({
    modelComplexity: 1,
    smoothLandmarks: true,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
});

pose.onResults((results) => {
    canvasCtx.save();
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
    canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
    
    // Draw pose landmarks and connections
    if (results.poseLandmarks) {
        drawingUtils.drawConnectors(
            canvasCtx, results.poseLandmarks, Pose.POSE_CONNECTIONS,
            {color: '#00FF00', lineWidth: 2}
        );
        drawingUtils.drawLandmarks(
            canvasCtx, results.poseLandmarks,
            {color: '#FF0000', lineWidth: 1}
        );
    }
    canvasCtx.restore();
});

// Camera setup
const camera = new Camera(videoElement, {
    onFrame: async () => {
        await pose.send({image: videoElement});
    },
    width: 640,
    height: 480
});

async function startRecording() {
    try {
        await camera.start();
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;

        // Setup media recorder
        const stream = canvasElement.captureStream(25);
        mediaRecorder = new MediaRecorder(stream, {
            mimeType: 'video/mp4;codecs=h264',
            videoBitsPerSecond: 2500000
        });

        mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) recordedChunks.push(e.data);
        };

        mediaRecorder.onstop = async () => {
            const blob = new Blob(recordedChunks, {type: 'video/mp4'});
            recordedChunks = [];
            
            const formData = new FormData();
            formData.append('file', blob, 'recording.mp4');

            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                document.getElementById('predictionResult').textContent = result.prediction;
                document.getElementById('confidenceResult').textContent = result.confidence;
            } catch (error) {
                console.error('Error:', error);
            }
        };

        mediaRecorder.start();
        setTimeout(() => {
            mediaRecorder.stop();
            camera.stop();
        }, 5000);

    } catch (error) {
        console.error('Error starting camera:', error);
    }
}
</script>

<style>
.video-container {
    position: relative;
    width: 640px;
    height: 480px;
    border: 2px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
}

.video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    transform: scaleX(-1); /* Mirror the video */
}

#outputCanvas {
    z-index: 2;
    pointer-events: none;
}
</style>
{% endblock %}