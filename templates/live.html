{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2>Live Shot Recognition</h2>
    <div class="row">
        <div class="col-md-6">
            <video id="preview" width="100%" autoplay muted></video>
            <div id="countdown" class="text-danger mb-2"></div>
            <button id="recordBtn" class="btn btn-primary" onclick="startRecording()">
                Start Recording (3 seconds)
            </button>
            <div id="result" class="mt-3">
                <h4>Prediction: <span id="predictionResult"></span></h4>
                <!-- <h4>Confidence: <span id="confidenceResult"></span>%</h4> -->
            </div>
        </div>
    </div>
</div>

<script>
    let mediaRecorder;
    let recordedChunks = [];
    
    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { 
                    width: 1280,
                    height: 720,
                    frameRate: 30 
                },
                audio: false
            });
            
            const preview = document.getElementById('preview');
            preview.srcObject = stream;
            
            mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'video/x-matroska;codecs=avc1',
                videoBitsPerSecond: 2500000
            });
    
            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) recordedChunks.push(e.data);
            };
    
            mediaRecorder.onstop = async () => {
                const blob = new Blob(recordedChunks, { type: 'video/x-matroska' });
                recordedChunks = [];
                
                const formData = new FormData();
                formData.append('file', blob, 'recording.mkv');
    
                try {
                    const response = await fetch('/predict', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    document.getElementById('predictionResult').textContent = result.prediction;
                    document.getElementById('confidenceResult').textContent = result.confidence;
                } catch (error) {
                    console.error('Error:', error);
                }
            };
    
            mediaRecorder.start();
            setTimeout(() => mediaRecorder.stop(), 3000);
            
        } catch (error) {
            console.error('Error accessing camera:', error);
        }
    }
</script>

<style>
#preview {
    border: 2px solid #ddd;
    border-radius: 8px;
    background: #000;
}

#result.processing {
    position: relative;
    opacity: 0.6;
}

#result.processing::after {
    content: "Analyzing...";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.8);
    font-weight: bold;
    color: #0d6efd;
}
</style>
{% endblock %}